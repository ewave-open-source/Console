var Dal=function(){function e(e){var n={"=":"$eq","!=":"$ne",">":"$gt",">=":"$gte","<":"$lt","<=":"$lte","in":"$in"};return void 0===n[e]?e:n[e]}function n(n,l){var t={queryMode:null,collection:"",where:{},values:{},limit:0},o=n.split(" ");if(t.queryMode=o[0].trim(),"SET"==o[2]){t.values={$set:{}};for(var i=n.substring(n.indexOf("SET")+3).split(","),u=0;u<i.length;u++){var c=i[u].split("=");t.values.$set[c[0].trim()]=l[c[0].trim()]}}for(var r=0;r<o.length;r++)if("UPDATE"==o[r]&&(t.collection=o[r+1]),"FROM"==o[r]&&(t.collection=o[r+1]),"INTO"==o[r]&&(t.collection=o[r+1],t.values=l),"WHERE"==o[r]){var a=t.where;"UPDATE"!=t.queryMode&&(a.$query={},a=a.$query);for(var i=n.substring(n.indexOf("WHERE")+6).split("AND"),u=0;u<i.length;u++){var c=i[u].split("@");if(!(c.length<2)){var s=c[1].replace(";","").trim();"$limit"===s&&(t.limit=l[s]);var d=e(c[0].replace(s,"").trim());"^^"!==d?(a[s]={},a[s][d]=l[s],"false"==l[s]&&(a[s][d]=!1),"true"==l[s]&&(a[s][d]=!0)):t.where[s]=l[s]}}}return t}function l(e){var n=(v.appSettings().database.diskdb.host,require("mongodb").Db),l=require("mongodb").Server,t=new n("scripter",new l("localhost",27017));t.open(function(n,l){q.equal(null,n),t.collections(function(n,l){q.ok(l.length>0);for(var t=[],o=0;o<l.length;o++)t.push(l[o].s.name);e(t)})})}function t(e,n){Dal.query("SELECT * FROM "+e,{},n)}function o(e,n,l){i(function(t,o){q.equal(null,t),o.collection(e).findOne({_id:n},function(e,n){l(null!==e||null===n?{error:"not found"}:n)})})}function i(e){v.appSettings().database||e("error",null);var n=require("../diskdb/diskdb.js");if(Dal.db&&null!==Dal.db)e(null,Dal.db);else{var l=n.connect(v.appSettings().database.diskdb.host);Dal.db=l,l.collection=function(e){return l.loadCollections([e]),void 0!=this[e]?(this[e].limit=function(){return this},this[e].each=function(e){e(null,this.results)},this[e]):{find:function(){return this},limit:function(e){return this},next:function(e){e(null,null)},ensureIndex:function(){},toArray:function(e){e(null,null)},each:function(e){e(null,null)},save:function(e,n){n(null,e)}}},e(null,l)}}function u(e,n,l){Dal.query("INSERT INTO schemas name=@name, schema=@schema",{name:e,schema:n},l)}function c(e,n){Dal.query("SELECT * FROM schemas WHERE name=@name",{name:e},n)}function r(e,n,l){v.appSettings().database.diskdb.host,require("mongodb").MongoClient;i(function(t,o){q.equal(null,t),o.collection(e).findAndRemove({id:n},function(e,n){q.equal(null,e),l(n)})})}function a(e,n,l,t,o){i(function(i,u){q.equal(null,i);var c={};c[l]=t,u.collection(n).update({_id:e},{$addToSet:c},function(e,n){o(n)})})}function s(e,n,l,t,o){i(function(i,u){q.equal(null,i);var c={};c[l]=t,u.collection(n).update({_id:e},{$push:c},function(e,n){o(n)})})}function d(e,n,l,t,o){i(function(i,u){q.equal(null,i);var c={};c[l]=t,u.collection(n).update({_id:e},{$pull:c},function(e,n){o(n)})})}function f(e,n,l){"string"==typeof e&&(e=[e]),i(function(t,o){q.equal(null,t),o.collection(n).find({_id:{$in:e}}).toArray(function(e,n){l(n)})})}function h(e,l,t){var o=n(e,l);o.where.$query&&(o.where=o.where.$query),i(function(e,n){switch(q.equal(null,e),o.queryMode){case"INSERT":void 0===o.values._id&&(o.values._id=require("node-uuid").v4()),n.collection(o.collection).save(o.values,function(e,n){q.equal(e,null),console.log("inserted document from "+o.collection),t(n)});break;case"DELETE":n.collection(o.collection).remove(o.where.$query,function(e,n){q.equal(e,null),console.log("deleted document from "+o.collection),t(n)});break;case"UPDATE":n.collection(o.collection).update(o.where,o.values,function(e,l){q.equal(e,null),console.log("updated document from "+o.collection);var i=n.collection(o.collection).find(o.where),u=[];i.each(function(e,n){q.equal(e,null),null!=n?u.push(n):t(u)})});break;case"SELECT":var l=!1;for(var i in o.where)l=!0;n.collection(o.collection).find(o.where).toArray(function(e,n){t(n)})}})}var v=(require("util"),require("fs"),require("path"),require("../config.js")),q=require("assert");return this.db=null,{connect:i,query:h,getAll:l,getCollection:t,getSingle:o,deleteCollection:r,saveSchema:u,getSchema:c,pushObject:s,getSet:f,pullObject:d,addToSet:a,db:null}}();module.exports=Dal;