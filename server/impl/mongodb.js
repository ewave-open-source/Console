var Dal=function(){function e(e){var n={"=":"$eq","!=":"$ne",">":"$gt",">=":"$gte","<":"$lt","<=":"$lte","in":"$in"};return void 0===n[e]?e:n[e]}function n(n,l){var o={queryMode:null,collection:"",where:{},values:{},limit:0},t=n.split(" ");if(o.queryMode=t[0].trim(),"SET"==t[2]){o.values={$set:{}};for(var i=n.substring(n.indexOf("SET")+3).split(","),u=0;u<i.length;u++){var c=i[u].split("=");o.values.$set[c[0].trim()]=l[c[0].trim()]}}for(var r=0;r<t.length;r++)if("UPDATE"==t[r]&&(o.collection=t[r+1]),"FROM"==t[r]&&(o.collection=t[r+1]),"INTO"==t[r]&&(o.collection=t[r+1],o.values=l),"WHERE"==t[r]){var a=o.where;"UPDATE"!=o.queryMode&&(a.$query={},a=a.$query);for(var i=n.substring(n.indexOf("WHERE")+6).split("AND"),u=0;u<i.length;u++){var c=i[u].split("@");if(!(c.length<2)){var s=c[1].replace(";","").trim();"$limit"===s&&(o.limit=l[s]);var d=e(c[0].replace(s,"").trim());"^^"!==d?(a[s]={},a[s][d]=l[s],"false"==l[s]&&(a[s][d]=!1),"true"==l[s]&&(a[s][d]=!0)):o.where[s]=l[s]}}}return o}function l(e){var n=(v.appSettings().database.mongodb.host,require("mongodb").Db),l=require("mongodb").Server,o=new n("scripter",new l("localhost",27017));o.open(function(n,l){h.equal(null,n),o.collections(function(n,l){h.ok(l.length>0);for(var o=[],t=0;t<l.length;t++)o.push(l[t].s.name);e(o)})})}function o(e,n){Dal.query("SELECT * FROM "+e,{},n)}function t(e,n,l){i(function(o,t){h.equal(null,o),t.collection(e).findOne({_id:q(n)},function(e,n){l(null!==e||null===n?{error:"not found"}:n)})})}function i(e){var n=v.appSettings().database.mongodb.host,l=require("mongodb").MongoClient;null===Dal.db?l.connect(n,function(n,l){Dal.db=l,e(n,l)}):e(null,Dal.db)}function u(e,n,l){Dal.query("INSERT INTO schemas name=@name, schema=@schema",{name:e,schema:n},l)}function c(e,n){Dal.query("SELECT * FROM schemas WHERE name=@name",{name:e},n)}function r(e,n,l){v.appSettings().database.mongodb.host,require("mongodb").MongoClient;i(function(o,t){h.equal(null,o),t.collection(e).findAndRemove({id:n},function(e,n){h.equal(null,e),l(n)})})}function a(e,n,l,o,t){i(function(i,u){h.equal(null,i);var c={};c[l]=o,u.collection(n).update({_id:e},{$addToSet:c},function(e,n){t(n)})})}function s(e,n,l,o,t){i(function(i,u){h.equal(null,i);var c={};c[l]=o,u.collection(n).update({_id:e},{$push:c},function(e,n){t(n)})})}function d(e,n,l,o,t){i(function(i,u){h.equal(null,i);var c={};c[l]=o,u.collection(n).update({_id:e},{$pull:c},function(e,n){t(n)})})}function f(e,n,l){"string"==typeof e&&(e=[e]),i(function(o,t){h.equal(null,o),t.collection(n).find({_id:{$in:e}}).toArray(function(e,n){l(n)})})}function m(e,l,o){var t=n(e,l);i(function(e,n){switch(h.equal(null,e),t.queryMode){case"INSERT":void 0===t.values._id&&(t.values._id=require("node-uuid").v4()),n.collection(t.collection).save(t.values,function(e,n){h.equal(e,null),console.log("inserted document from "+t.collection),o(n)});break;case"DELETE":n.collection(t.collection).remove(t.where.$query,function(e,n){h.equal(e,null),console.log("deleted document from "+t.collection),o(n)});break;case"UPDATE":n.collection(t.collection).update(t.where,t.values,function(e,l){h.equal(e,null),console.log("updated document from "+t.collection);var i=n.collection(t.collection).find(t.where),u=[];i.each(function(e,n){h.equal(e,null),null!=n?u.push(n):o(u)})});break;case"SELECT":var l,i=[],u=!1;for(var c in t.where)u=!0;l=u?n.collection(t.collection).find(t.where):n.collection(t.collection).find(),void 0===t.limit&&(t.limit=0),l.limit(t.limit).each(function(e,n){h.equal(e,null),null!=n?i.push(n):o(i)})}})}var v=(require("util"),require("fs"),require("path"),require("../config.js")),q=require("mongodb").ObjectID,h=require("assert");return this.db=null,{connect:i,query:m,getAll:l,getCollection:o,getSingle:t,deleteCollection:r,saveSchema:u,getSchema:c,pushObject:s,getSet:f,pullObject:d,addToSet:a,db:null}}();module.exports=Dal;